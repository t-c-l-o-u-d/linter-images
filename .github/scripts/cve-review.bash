#!/usr/bin/env bash
# GNU Affero General Public License v3.0 or later (see COPYING or https://www.gnu.org/licenses/agpl.txt)
# Compare scan results against ignore files and open an issue if any ignored CVEs are removable.
# Called by .github/workflows/cve-review.yaml — expects artifacts downloaded into cves-*/ directories.

set -euo pipefail

# Merge all scan results
cat cves-*/trivy-cves.txt 2>/dev/null | sort --unique > all-trivy.txt
cat cves-*/grype-cves.txt 2>/dev/null | sort --unique > all-grype.txt

REPORT=$(mktemp)

# Compare Trivy ignore file against scan results
REMOVABLE_TRIVY=""
while IFS= read -r cve; do
  [[ "${cve}" =~ ^# ]] && continue
  [[ -z "${cve}" ]] && continue
  if ! grep --quiet --fixed-strings "${cve}" all-trivy.txt; then
    REMOVABLE_TRIVY="${REMOVABLE_TRIVY}${cve}\n"
  fi
done < .linter/.trivyignore

# Compare Grype ignore file against scan results
REMOVABLE_GRYPE=""
while IFS= read -r line; do
  cve=$(echo "${line}" | grep --only-matching --perl-regexp 'CVE-\S+' || true)
  [[ -z "${cve}" ]] && continue
  if ! grep --quiet --fixed-strings "${cve}" all-grype.txt; then
    REMOVABLE_GRYPE="${REMOVABLE_GRYPE}${cve}\n"
  fi
done < .linter/.grype.yaml

# Open an issue if any ignored CVEs are no longer detected
if [[ -n "${REMOVABLE_TRIVY}" || -n "${REMOVABLE_GRYPE}" ]]; then
  {
    echo "## CVE Review — $(date +%Y-%m-%d)"
    echo ""
    echo "The following ignored CVEs were **not found** in the latest scans and may be removable."
    echo ""
    if [[ -n "${REMOVABLE_TRIVY}" ]]; then
      echo "### Trivy (\`.linter/.trivyignore\`)"
      echo '```'
      echo -e "${REMOVABLE_TRIVY}"
      echo '```'
    fi
    if [[ -n "${REMOVABLE_GRYPE}" ]]; then
      echo "### Grype (\`.linter/.grype.yaml\`)"
      echo '```'
      echo -e "${REMOVABLE_GRYPE}"
      echo '```'
    fi
  } > "${REPORT}"

  echo "::warning::Some ignored CVEs may be removable — opening issue."
  gh label create "maintenance" --description "Routine maintenance tasks" --color "0e8a16" 2>/dev/null || true
  gh issue create \
    --title "CVE review: ignored CVEs may be removable" \
    --body "$(cat "${REPORT}")" \
    --label "maintenance"
else
  echo "All ignored CVEs are still present. No action needed."
fi
