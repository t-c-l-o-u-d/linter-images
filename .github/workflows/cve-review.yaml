---
# GNU Affero General Public License v3.0 or later (see COPYING or https://www.gnu.org/licenses/agpl.txt)
# Check if any ignored CVEs have been fixed upstream and can be removed.

name: CVE Review

on:
  schedule:
    - cron: '0 7 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  packages: read
  issues: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.list.outputs.images }}
    steps:
      - uses: actions/checkout@v6
      - name: List all images
        id: list
        shell: bash
        run: |
          IMAGES=$( \
            ls -d images/lint-* images/base-linter \
            | xargs -I{} basename {} \
            | jq --raw-input --slurp --compact-output \
              'split("\n") | map(select(length > 0))' \
          )
          echo "images=${IMAGES}" >> "${GITHUB_OUTPUT}"

  scan-trivy:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover.outputs.images) }}
    steps:
      - uses: actions/checkout@v6
      - name: Authenticate to the registry
        shell: bash
        run: |
          mkdir --parents "${HOME}/.docker"
          echo "${{ secrets.GITHUB_TOKEN }}" \
            | buildah login \
              --authfile "${HOME}/.docker/config.json" \
              --username "${{ github.actor }}" \
              --password-stdin \
              ghcr.io
      # Scan without ignore files so we see all current findings
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: 'ghcr.io/${{ github.repository }}/${{ matrix.image }}:latest'
          format: 'json'
          output: 'trivy-results.json'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM'
      - name: Extract found CVEs
        shell: bash
        run: |
          jq --raw-output '.. | .VulnerabilityID? // empty' \
            trivy-results.json 2>/dev/null \
            | sort --unique > trivy-cves.txt \
            || touch trivy-cves.txt
      - name: Upload CVE list
        uses: actions/upload-artifact@v6
        with:
          name: trivy-cves-${{ matrix.image }}
          path: trivy-cves.txt

  scan-grype:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover.outputs.images) }}
    steps:
      - uses: actions/checkout@v6
      - name: Authenticate to the registry
        shell: bash
        run: |
          mkdir --parents "${HOME}/.docker"
          echo "${{ secrets.GITHUB_TOKEN }}" \
            | buildah login \
              --authfile "${HOME}/.docker/config.json" \
              --username "${{ github.actor }}" \
              --password-stdin \
              ghcr.io
      # Scan without ignore files so we see all current findings
      - name: Scan with Grype
        id: grype
        uses: anchore/scan-action@v7.3.2
        with:
          image: 'ghcr.io/${{ github.repository }}/${{ matrix.image }}:latest'
          output-format: 'json'
          severity-cutoff: 'medium'
          only-fixed: 'true'
          by-cve: 'true'
          fail-build: 'false'
      - name: Extract found CVEs
        shell: bash
        run: |
          jq --raw-output '.matches[]?.vulnerability.id // empty' \
            "${{ steps.grype.outputs.json }}" 2>/dev/null \
            | sort --unique > grype-cves.txt \
            || touch grype-cves.txt
      - name: Upload CVE list
        uses: actions/upload-artifact@v6
        with:
          name: grype-cves-${{ matrix.image }}
          path: grype-cves.txt

  review:
    needs: [scan-trivy, scan-grype]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download all scan results
        uses: actions/download-artifact@v7
        with:
          pattern: '*-cves-*'
      - name: Compare against ignore files
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: .github/scripts/cve-review.bash
